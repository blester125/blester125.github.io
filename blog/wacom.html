<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-156541294-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "UA-156541294-1");
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <meta
      name="og:description"
      content="A dive into my solution for re-configuration of my Wacom tablet when I plug it in."
    />
    <meta name="og:title" content="Hot-swapping a Wacom Tablet on Linux" />
    <meta name="og:url" content="https://blester125.com/blog/wacom.html" />
    <meta
      name="og:image"
      content="https://blester125.com/static/img/blog/wacom/ball.gif"
    />
    <meta name="twitter:card" content="summary_large_image" />

    <meta name="author" content="Brian Lester" />
    <title>Hot-swapping a Wacom Tabley on Linux</title>

    <!-- Third Party CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
      crossorigin="anonymous"
    />

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css"
      integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0="
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/jpswalsh/academicons/v1.8.6/css/academicons.min.css"
      integrity="sha384-qpNsn9fNAkiBXwcwfxPTn1Ou6UU9P6pYGWQqLRIJOlPsAKOA+8XzN2coCnVnb8Fa"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Kaushan+Script"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700"
      rel="stylesheet"
      type="text/css"
    />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js" integrity="sha384-0s5Pv64cNZJieYFkXYOTId2HMA2Lfb6q2nAcx2n0RTLUnCAoTTsS0nKEO27XyKcY" crossorigin="anonymous"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js" integrity=sha384-ZoaMbDF+4LeFxg6WdScQ9nnR1QC2MIRxA1O9KWEXQwns1G8UNyIEZIQidzb0T1fo" crossorigin="anonymous"></script>
    <![endif]-->

    <!-- favicon, the logo in the tab -->
    <link rel="icon" href="static/img/favicon.ico" type="image/x-icon" />
    <link
      rel="shortcut icon"
      href="static/img/favicon.ico"
      type="image/x-icon"
    />

    <!-- Third Party Javascript -->
    <script
      src="https://code.jquery.com/jquery-1.11.1.min.js"
      integrity="sha256-VAvG3sHdS5LqTT+5A/aeq/bZGa/Uj04xKxY8KM/w9EE="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
      integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
      crossorigin="anonymous"
    ></script>
    <script src="../static/js/vendored/jquery.scrollintoview.min.js"></script>

    <!-- Code formatting -->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>

    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js"
      crossorigin="anonymous"
    ></script>

    <!-- Custom CSS -->
    <link href="../static/css/agency.css" rel="stylesheet" />
    <link href="../static/css/teaching.css" rel="stylesheet" type="text/css" />
    <link href="../static/css/nav.css" rel="stylesheet" />

    <!-- Custom JS -->
    <script src="../static/js/agency.js"></script>
  </head>
  <body class="bg-light-gray">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-shrink">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
          <button
            type="button"
            class="navbar-toggle"
            data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1"
          >
            <span class="sr-only">Toggle navigation</span>
            <i class="fas fa-bars fa-1x"></i>
          </button>
          <a class="navbar-brand page-scroll" href="../#page-top">
            Brian Lester
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li class="hidden">
              <a href="../#page-top"></a>
            </li>
            <li>
              <a class="page-scroll" href="../static/resume/BrianLesterCV.pdf">
                Resume
              </a>
            </li>
            <li>
              <a class="page-scroll" href="../#blog">Blog</a>
            </li>
            <li>
              <a class="page-scroll" href="../#experience">Experience</a>
            </li>
            <li>
              <a class="page-scroll" href="../#skills">Skills</a>
            </li>
            <li>
              <a class="page-scroll" href="../#presentations">Presentations</a>
            </li>
            <li>
              <a class="page-scroll" href="../#publications">Publications</a>
            </li>
            <li>
              <a class="page-scroll" href="../#projects">Projects</a>
            </li>
            <li>
              <a class="page-scroll" href="../#education">Education</a>
            </li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
    </nav>

    <div class="container">
      <div class="content">
        <div class="section" id="title">
          <center>
            <h1>
              Hot-swapping a Wacom Tablet on Linux
            </h1>
          </center>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <p class="text-muted indent">
              Inspired by the very good (but incredibly weird)
              <a
                href="https://www.adultswim.com/videos/smiling-friends/smiling-friends"
                >Similing Friends</a
              ><a></a>, I decided to try my hand at animation. It is difficult
              to overstate just how bizarre the show is but you can't help but
              watch and really notice how they pulled out all the stops. There
              is normal 2D animation, 3D animation, rotoscoped sections, and
              even one of those super gross, painted close ups you see sometimes
              in Sponge Bob. There was even a character watching a live action
              clip on a tablet. I really recommend the show but I totally
              understand if it turns out too weird for you.
            </p>
            <p class="text-muted indent">
              I've never been a very good artist and I definitely have never
              been about to draw consistently or quickly. Given that these are
              some of the first skills that jump to ones mind when they here
              animation you might be wondering what is wrong with me. My real
              good is to be able to make something interesting and creative and
              I hope that by picking 2D animation as a medium I'll be forced to
              learn these skills. At a minimum I expect to get better at draw
              circles, squares, and straight lines which should make the white
              board drawing I do when explaining a complex algorithm a bit
              easier to read.
            </p>
            <p class="text-muted indent">
              To facilitate this I got a drawing tablet. I went with the
              <a
                href="https://www.wacom.com/en-us/products/pen-tablets/wacom-intuos"
                >Wacom Intuos Small</a
              ><a></a>. Given my skills on display here it should be clear I'm
              not sponsored, this is just the tablet I got, it seems to work
              well as a first tablet that is on the cheaper side. The problem is
              that I use Linux on my daily driver and Wacom tablets aren't
              supported. I've put a decent amount of work into getting
              everything running smoothly and I wanted to share what I did here.
            </p>
          </div>
          <div class="col-lg-6">
            <figure>
              <img
                src="../static/img/blog/wacom/ball.gif"
                alt="A bounding ball animation"
                class="img-responsive thumbnail"
              />
              <figcaption>
                The classic bouncing ball everyone animates. It show cases a few
                techniques that I learned from
                <a
                  href="https://www.amazon.com/Animators-Survival-Kit-Richard-Williams/dp/0571202284"
                  >The Animator's Survival Kit</a
                ><a></a>. Note the "Squash and Stretch", the ball stretches as
                it approaches the ground and squishes as it hits the ground. It
                also has "Slow In, Slow Out" where the ball slows at the peaks
                of its bounces.
              </figcaption>
            </figure>
          </div>
        </div>
        <div class="row col-lg-8 col-lg-offset-2">
          <h3>Setting up the Wacom Drivers</h3>

          <p class="text-muted indent">
            Unfortunately, Wacom tablets aren't supported on Linux. This means
            that there aren't official drivers published by Wacom to facilitate
            communication between the tablet and your computer. Luckily for us
            there is a great community of people creating
            <a href="https://linuxwacom.github.io/">open source drivers</a
            ><a></a> for these tablets. Often these drivers ship with newer
            versions of Linux. I personally only had to install
            <span class="tt">libwacom</span>. I installed from source and their
            documentation was pretty through and made the process easy.
          </p>

          <h3>Configuring the Tablet with <span class="tt">xsetwacom</span></h3>

          <p class="text-muted indent">
            The nice people over at The Linux Wacom Project who make the open
            source drivers provide a handy tool,
            <span class="tt">xsetwacom</span>, designed to facilitate things
            like the configuration of the button that are commonly found on both
            the tablets and on the styluses themselves.
          </p>

          <h4>Configuring the Buttons.</h4>

          <p class="text-muted indent">
            <span class="tt">xsetwacom</span> configures parts of the Wacom
            eco-system by natural name rather than by id of the like. The
            command <code>xsetwacom list</code> will return the name, id, and
            type (<span class="tt">ERASER, STYLUS, PAD</span>, etc.). We can use
            the <span class="tt">get</span> command to see the value of a
            setting. We normally see calls like
            <code>xsetwacom get "{device name}" {parameter}</code>. We can use
            <span class="tt">xsetwacom list parameters</span> to see all the
            set-able values. Once we decide on the value we set it like so
            <code>xsetwacom set "{device name}" {parameter} {value}</code>, for
            example,
            <code
              >xsetwacom set "Wacom Intuos S Pad pad" Button 1 "key ctrl
              z"</code
            >
            sets button one on the tablet so the "undo" hotkey.
          </p>

          <h4>Configuring the Available Writing Space.</h4>

          <p class="text-muted indent">
            One quirk of Wacom tablets is that when you have multiple monitors
            the drawing surface defaults to mapping to the whole screen.
            Touching on the left edge of the tablet jumps to the left edge of
            the left most monitor while the right edge would be all the way over
            on the right side of the right monitor. This often cause tiny
            movements on the pad to be a huge jump on the screen. We use the
            <span class="tt">MapToOutput</span> command to limit the drawing
            surface to a particular screen. You are supposed to be able to use
            the name of the display that you get back from
            <span class="tt">xrandr</span> but that never worked for me. When
            this fails you can use the index (starting from zero) of the screen
            when you consider the active screens. For example I use
            <code
              >xsetwacom set "Wacom Intuos S Pen stylus" MapToOutput
              Head-0</code
            >.
          </p>

          <p></p>

          <h3>Re-configuration as you Remove and Plug-In the Tablet.</h3>

          <p class="text-muted indent">
            The problem is that you'll need to re-configure your tablet each
            time you plug in your tablet or restart your computer. You can wrap
            up all your configuration in a script and run that like I
            <a
              href="https://github.com/blester125/dotfiles/blob/master/wacom/xsetwacom.sh"
              >did</a
            ><a></a>. This is still a manual process that I would personally
            forget to do all the time. Now we are going to look into how to do
            this automatically.
          </p>

          <h4>A Failed Attempt with <span class="tt">udev</span> Rules.</h4>

          <p class="text-muted indent">
            Linux has things called <span class="tt">udev</span> rules. These
            are actions that you can configure that are triggered when new
            devices are plugged in. We can write a rule like
            <code
              >SUBSYTEM=="usb", ATTRS{idVendor}=="XXXX", ATTRS{idProduct} ==
              "YYYY", RUN+="/path/to/my/script"</code
            >
            to run a script when a usb device is plugged in with an vendor id of
            <span class="tt">XXXX</span> and a product id of
            <span class="tt">YYYY</span>.
          </p>

          <p class="text-muted indent">
            My first though was to run my setup script each time it detected
            that my tablet was plugged in. The problem was that for
            <span class="tt">xsetwacom</span> to work on the table the X server
            needs to detect and process the tablet. This happens long after the
            <span class="tt">udev</span> rule fires. People online were working
            on trying to use sleeps to handle this but the problem was that you
            needed a wrapper that would background itself once sleeping
            (otherwise the sleep to wait for X would block and X wouldn't
            actually detect it before we try to run the script). This was
            getting far too complex so I want with a different solution.
          </p>

          <h4>Finding the vendor and product ids.</h4>

          <p class="text-muted indent">
            Both the <span class="tt">udev</span> rule and my eventual solution
            require the vendor id and product id of the table. This can be
            gotten with <code>lsusb</code>. The output will look like
            <code>Bus 001 Device 006: ID 056a:0374 Wacom Co., Ltd</code> which
            you can interpret like so
            <code
              >Bus {bus_number} Device {device_number}: ID
              {vendor_id}:{product_id} {product_name}</code
            >.
          </p>

          <h3>A Long Running <span class="tt">udev</span> Listener Service.</h3>

          <p class="text-muted indent">
            Instead of using a <span class="tt">udev</span> rules I wrote a
            <a
              href="https://github.com/blester125/dotfiles/blob/master/wacom/wacom-listener.py"
              >python script</a
            >
            that listens to <span class="tt">udev</span> events. This is makes
            it easier to have sleeps to wait for X to detect the tablet. This
            script simply sits there and when a new device comes in with a
            matching vendor id and product id we trigger our configuration
            script. This script makes the tablet responsive to unplugging. Once
            you plug it back in it will get re-configured.
          </p>

          <h4>A Note on Dependency Management.</h4>

          <p class="text-muted indent">
            My long running listener uses the
            <span class="tt">pyudev</span> library. There are a few ways to make
            this library accessible to the system service. I chose to install
            the library in a <span class="tt">pyenv</span> environment. In my
            listener script I point the <code>#!</code> line to the python
            binary for this environment. When we execute this script it uses
            this python interpreter. Other solutions would be to call the script
            through that interpreter manually.
          </p>

          <h3>
            <span class="tt">systemd</span> For Automatic Starts and Reloads on
            Failure.
          </h3>

          <p class="text-muted indent">
            The long-running server method works well but there is still the
            manual step of starting it every time you boot your computer and
            restarting it if it ever crashes. We use
            <span class="tt">systend</span> to manage this service for us.
          </p>

          <!-- HTML generated using hilite.me -->
          <div
            style="
              background: #f8f8f8;
              overflow: auto;
              width: auto;
              padding: 0.2em 0.6em;
            "
          >
            <pre
              style="margin: 0; line-height: 125%;"
            ><span style="color: #008000; font-weight: bold">[Unit]</span>
<span style="color: #7D9029">Description</span><span style="color: #666666">=</span><span style="color: #BA2121">Wacom Plugin Service</span>

<span style="color: #008000; font-weight: bold">[Service]</span>
<span style="color: #7D9029">ExecStart</span><span style="color: #666666">=</span><span style="color: #BA2121">/home/brian/.shellrc/wacom/wacom-listener.py</span>
<span style="color: #7D9029">Restart</span><span style="color: #666666">=</span><span style="color: #BA2121">on-failure</span>
<span style="color: #7D9029">RestartSec</span><span style="color: #666666">=</span><span style="color: #BA2121">10</span>
<span style="color: #7D9029">StartLimitBurst</span><span style="color: #666666">=</span><span style="color: #BA2121">10</span>
<span style="color: #7D9029">Type</span><span style="color: #666666">=</span><span style="color: #BA2121">simple</span>
<span style="color: #7D9029">Environment</span><span style="color: #666666">=</span><span style="color: #BA2121">PYTHONUNBUFFERED=1</span>

<span style="color: #008000; font-weight: bold">[Install]</span>
<span style="color: #7D9029">WantedBy</span><span style="color: #666666">=</span><span style="color: #BA2121">default.target</span>
</pre>
          </div>

          <p class="text-muted indent">
            This is our service configuration file, I've called it
            <code>wacom.service</code>. There are obvious values like
            <span class="tt">Description</span> which is the natural language
            summary of what your service does.
            <span class="tt">ExecStart</span> tells us how to run the service
            while keys like <span class="tt">Restart</span> and
            <span class="tt">RestartSec</span> control the settings for which to
            restart the service.
          </p>

          <p class="text-muted indent">
            One thing to point out is the line
            <code>Environment=PYTHONUNBUFFERED=1</code>. This sets an
            environment variable in the service. In this particular case we are
            making the python output unbuffered. Normally python doesn't
            actually print the output(or write it to a file) until a
            <code>\n</code> is printed or the buffer files up. This environment
            variable makes it so we always output. This is needed to make the
            logging in the modules show up with
            <span class="tt">journalctl</span>.
          </p>

          <p class="text-muted indent">
            The following steps are needed to enable the service.
          </p>

          <ol class="text-muted">
            <li>
              Copy the service file into <code>~/.config/systemd/user/</code>.
              Note that this needs to be a copy and not a soft link. When
              enabling the service a soft link will be created and will complain
              about having too many levels of soft lengths.
            </li>
            <li>Run <code>systemctl --user enable wacom.service</code></li>
            <li>Run <code>systemctl --user start wacom.service</code></li>
            <li>
              Run <code>systemctl --user status wacom.service</code> to monitor
              the health of the service
            </li>
            <li>
              We can stop the service with
              <code>systemctl --user stop wacom.serivce</code>, disable it with
              <code>systemctl --user disable wacom.service</code>, and if we
              change the service definition file we can reload the service with
              <code
                >systemctl --user daemond-reload && systemctl --user restart
                wacom.service</code
              >
            </li>
          </ol>

          <p class="text-muted indent">
            We can use <code>journalctl --user-unit wacom.service</code> to get
            the logs from the service.
          </p>

          <p class="text-muted indent">
            Now <span class="tt">systemd</span> should manage starting our
            service on boot and restarting it should it crash. We can simulate a
            crash with
            <code>systemctl --user --signal=SIGKILL kill wacom.service</code>
            and see how systemd will bring it back up.
          </p>
          <p class="text-muted indent">
            Note: For most of these commands we should be able to drop the
            <span class="tt">.service</span> suffix and just call is wacom when
            using systemctl
          </p>

          <p class="text-muted indent">
            Now this listener service should make it so that when we plug in the
            tablet our defaults should be loaded.
          </p>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <figure>
              <img
                src="../static/img/blog/wacom/roll-eyes.gif"
                alt="An animation of a guy rolling his eyes"
                class="img-responsive thumbnail"
              />
              <figcaption>
                A rolling eyes reaction I make with <a href="">OpenToonz</a>.
                It's the open source version of the software Studio Ghibli uses.
                I think I'm pretty close to Hayao Miyazaki level tbh.
              </figcaption>
            </figure>
          </div>
          <div class="col-lg-6">
            <p class="text-muted indent">
              Hopefully this post can help someone who is trying setup their
              Wacom tablet on Ubuntu Linux. I'm still draw poorly but at least
              now I can create my own reaction gifs. I'm think I'm going to go
              draw a flower pot sliding across the flow to work on "overlapping
              action", "drag", and "follow though".
            </p>

            <p></p>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark-gray">
      <div class="container">
        <div class="row">
          <div class="col-md-4">
            <span class="copyright">Brian Lester, 2020</span>
          </div>
          <div class="col-md-4">
            <!-- This should match the top one -->
            <ul class="list-inline social-buttons">
              <li>
                <a href="https://twitter.com/blester125">
                  <i class="fab fa-twitter"></i>
                </a>
              </li>
              <li>
                <a href="https://www.linkedin.com/in/blester125">
                  <i class="fab fa-linkedin"></i>
                </a>
              </li>
              <li>
                <a
                  href="https://scholar.google.com/citations?user=OWSQqZMAAAAJ&hl=en"
                >
                  <i class="ai ai-google-scholar"></i>
                </a>
              </li>
              <li>
                <a href="https://pypi.org/user/BLester125/">
                  <i class="fab fa-python"></i>
                </a>
              </li>
              <li>
                <a href="https://github.com/blester125">
                  <i class="fab fa-github"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
            <ul class="list-inline quicklinks">
              <li>
                Design based on "
                <a href="http://startbootstrap.com/template-overviews/agency/">
                  Agency
                </a>
                " template.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
